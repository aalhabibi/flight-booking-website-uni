<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Company Dashboard - Flight Booking System</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css"
    />
  </head>
  <body>
    <header class="header">
      <div class="container">
        <div class="header-content">
          <a href="company-home.html" class="logo">✈️ Flight Booking</a>
          <nav class="nav">
            <a href="company-home.html" class="nav-link">Home</a>
            <a href="company-profile.html" class="nav-link">Profile</a>
            <a href="#" class="nav-link" id="messagesLink">Messages</a>
            <button class="btn btn-secondary btn-sm" onclick="logout()">
              Logout
            </button>
          </nav>
        </div>
      </div>
    </header>

    <div class="container">
      <!-- Company Header -->
      <div class="company-header">
        <div class="company-header-content">
          <img
            id="companyLogo"
            src=""
            alt="Company Logo"
            class="company-logo"
            style="display: none"
          />
          <div class="company-info">
            <h1 id="companyName">Loading...</h1>
            <p id="companyLocation"></p>
          </div>
        </div>
      </div>

      <!-- Actions Bar -->
      <div class="actions-bar">
        <button class="btn btn-primary" id="addFlightBtn">+ Add Flight</button>
        <button class="btn btn-secondary" onclick="location.reload()">
          Refresh
        </button>
      </div>

      <!-- Alerts -->
      <div id="alert-container"></div>

      <!-- Flights List -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">My Flights</h2>
          <span id="flightsCount" class="text-secondary">0 flights</span>
        </div>

        <div id="loadingFlights" class="loading">
          <div class="spinner"></div>
          <p>Loading flights...</p>
        </div>

        <div id="flightsContainer" style="display: none">
          <table class="flights-table">
            <thead>
              <tr>
                <th>Flight Code</th>
                <th>Flight Name</th>
                <th>Itinerary</th>
                <th>Passengers</th>
                <th>Fees</th>
                <th>Status</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody id="flightsTableBody"></tbody>
          </table>
        </div>

        <div id="noFlights" class="empty-state" style="display: none">
          <div class="empty-state-icon">✈️</div>
          <h3>No flights yet</h3>
          <p>Get started by adding your first flight!</p>
          <button
            class="btn btn-primary mt-2"
            onclick="$('#addFlightBtn').click()"
          >
            Add Flight
          </button>
        </div>
      </div>
    </div>

    <!-- Add Flight Modal -->
    <div id="addFlightModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Add New Flight</h2>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="addFlightForm">
            <div class="form-group">
              <label class="form-label" for="flight_name">Flight Name</label>
              <input
                type="text"
                id="flight_name"
                name="flight_name"
                class="form-input"
                required
                minlength="3"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="flight_code">Flight Code</label>
              <input
                type="text"
                id="flight_code"
                name="flight_code"
                class="form-input"
                required
                minlength="3"
                style="text-transform: uppercase"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="max_passengers"
                >Max Passengers</label
              >
              <input
                type="number"
                id="max_passengers"
                name="max_passengers"
                class="form-input"
                required
                min="1"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="fees">Fees (USD)</label>
              <input
                type="number"
                id="fees"
                name="fees"
                class="form-input"
                required
                min="0"
                step="0.01"
              />
            </div>

            <div class="form-group">
              <label class="form-label">Itinerary</label>
              <div id="itineraryContainer">
                <div class="itinerary-item-form">
                  <div class="d-flex gap-2 mb-2">
                    <input
                      type="text"
                      class="form-input"
                      placeholder="City"
                      required
                      style="flex: 1"
                    />
                    <input
                      type="datetime-local"
                      class="form-input"
                      placeholder="Start"
                      required
                    />
                    <input
                      type="datetime-local"
                      class="form-input"
                      placeholder="End"
                      required
                    />
                    <button
                      type="button"
                      class="btn btn-danger btn-sm remove-itinerary"
                      style="display: none"
                    >
                      Remove
                    </button>
                  </div>
                </div>
              </div>
              <button
                type="button"
                class="btn btn-secondary btn-sm"
                id="addItineraryStop"
              >
                + Add Stop
              </button>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="$('#addFlightModal').removeClass('active')"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">Add Flight</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Flight Details Modal -->
    <div id="flightDetailsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Flight Details</h2>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div id="flightDetailsContent">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading flight details...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="js/app.js"></script>
    <script>
      let companyInfo = {};
      let flights = [];

      // Load company info and flights
      function loadCompanyData() {
        getProfile()
          .done(function (response) {
            if (response.success) {
              companyInfo = response.data;
              $("#companyName").text(companyInfo.name || "Company");
              if (companyInfo.logo_url) {
                $("#companyLogo").attr("src", companyInfo.logo_url).show();
              }
              if (companyInfo.location) {
                $("#companyLocation").text(companyInfo.location);
              }
            }
          })
          .fail(function () {
            window.location.href = "login.html";
          });

        loadFlights();
      }

      // Load flights
      function loadFlights() {
        $("#loadingFlights").show();
        $("#flightsContainer").hide();
        $("#noFlights").hide();

        getCompanyFlights()
          .done(function (response) {
            $("#loadingFlights").hide();

            if (
              response.success &&
              response.data.flights &&
              response.data.flights.length > 0
            ) {
              flights = response.data.flights;
              $("#flightsCount").text(
                `${flights.length} flight${flights.length !== 1 ? "s" : ""}`
              );
              renderFlights();
              $("#flightsContainer").show();
            } else {
              $("#noFlights").show();
            }
          })
          .fail(function () {
            $("#loadingFlights").hide();
            showAlert("Failed to load flights", "error");
          });
      }

      // Render flights table
      function renderFlights() {
        const tbody = $("#flightsTableBody");
        tbody.empty();

        flights.forEach((flight) => {
          const row = $("<tr>").attr("data-flight-id", flight.id);

          row.append($("<td>").text(flight.flight_code));
          row.append($("<td>").text(flight.flight_name));
          row.append($("<td>").text(flight.itinerary_string || "N/A"));
          row.append(
            $("<td>").text(
              `${flight.registered_passengers || 0} / ${flight.max_passengers}`
            )
          );
          row.append($("<td>").text(formatCurrency(flight.fees)));
          row.append(
            $("<td>").html(
              `<span class="flight-status ${flight.status}">${flight.status}</span>`
            )
          );
          row.append($("<td>").text(formatDate(flight.created_at)));

          row.on("click", function () {
            showFlightDetails(flight.id);
          });

          tbody.append(row);
        });
      }

      // Show flight details
      function showFlightDetails(flightId) {
        $("#flightDetailsModal").addClass("active");
        $("#flightDetailsContent").html(
          '<div class="loading"><div class="spinner"></div><p>Loading flight details...</p></div>'
        );

        getFlightDetails(flightId)
          .done(function (response) {
            if (response.success) {
              const flight = response.data;
              renderFlightDetails(flight);
            } else {
              $("#flightDetailsContent").html(
                '<div class="alert alert-error">Failed to load flight details</div>'
              );
            }
          })
          .fail(function () {
            $("#flightDetailsContent").html(
              '<div class="alert alert-error">Failed to load flight details</div>'
            );
          });
      }

      // Render flight details
      function renderFlightDetails(flight) {
        let html = `
                <div class="profile-section">
                    <h3 class="profile-section-title">Flight Information</h3>
                    <div class="form-group">
                        <strong>ID:</strong> ${flight.id}<br>
                        <strong>Name:</strong> ${flight.flight_name}<br>
                        <strong>Code:</strong> ${flight.flight_code}<br>
                        <strong>Status:</strong> <span class="flight-status ${
                          flight.status
                        }">${flight.status}</span><br>
                        <strong>Max Passengers:</strong> ${
                          flight.max_passengers
                        }<br>
                        <strong>Registered Passengers:</strong> ${
                          flight.registered_passengers || 0
                        }<br>
                        <strong>Fees:</strong> ${formatCurrency(flight.fees)}
                    </div>
                </div>
                
                <div class="profile-section">
                    <h3 class="profile-section-title">Itinerary</h3>
                    <ul class="itinerary-list">
            `;

        if (flight.itinerary && flight.itinerary.length > 0) {
          flight.itinerary.forEach((stop) => {
            html += `
                        <li class="itinerary-item">
                            <span class="itinerary-city">${stop.city}</span>
                            <span class="itinerary-time">${formatDate(
                              stop.start_datetime
                            )} → ${formatDate(stop.end_datetime)}</span>
                        </li>
                    `;
          });
        } else {
          html += "<li>No itinerary available</li>";
        }

        html += `
                    </ul>
                </div>
                
                <div class="profile-section">
                    <h3 class="profile-section-title">Registered Passengers</h3>
                    <div class="passengers-list">
            `;

        if (
          flight.registered_passengers &&
          flight.registered_passengers.length > 0
        ) {
          html += `<p class="text-secondary mb-2">Total: ${flight.registered_passengers.length} passenger(s)</p>`;
          flight.registered_passengers.forEach((passenger) => {
            html += `
                        <div class="passenger-item">
                            <div class="passenger-avatar" style="background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center;">
                                ${
                                  passenger.name
                                    ? passenger.name.charAt(0).toUpperCase()
                                    : "P"
                                }
                            </div>
                            <div class="passenger-info">
                                <div class="passenger-name">${
                                  passenger.name
                                }</div>
                                <div class="passenger-email">${
                                  passenger.email
                                }</div>
                                <div class="passenger-email" style="font-size: 0.75rem;">Payment: ${
                                  passenger.payment_method === "account"
                                    ? "Account"
                                    : "Cash"
                                } - ${formatCurrency(
              passenger.amount_paid
            )}</div>
                            </div>
                        </div>
                    `;
          });
        } else {
          html += '<p class="text-secondary">No registered passengers</p>';
        }

        // Note: Pending passengers would be shown here if the backend API supports it
        // Currently, all bookings are confirmed upon creation

        html += `
                    </div>
                </div>
                
                <div class="modal-footer">
            `;

        if (flight.status !== "cancelled") {
          html += `
                    <button class="btn btn-danger" id="cancelFlightBtn" data-flight-id="${flight.id}">Cancel Flight & Refund</button>
                `;
        }

        html += `
                    <button class="btn btn-secondary" onclick="$('#flightDetailsModal').removeClass('active')">Close</button>
                </div>
            `;

        $("#flightDetailsContent").html(html);

        // Handle cancel flight
        $("#cancelFlightBtn").on("click", function () {
          const flightId = $(this).data("flight-id");
          if (
            confirm(
              "Are you sure you want to cancel this flight? All passengers will be refunded."
            )
          ) {
            cancelFlight(flightId)
              .done(function (response) {
                if (response.success) {
                  showAlert(
                    "Flight cancelled successfully. Refunds processed.",
                    "success"
                  );
                  $("#flightDetailsModal").removeClass("active");
                  loadFlights();
                } else {
                  showAlert(
                    response.message || "Failed to cancel flight",
                    "error"
                  );
                }
              })
              .fail(function () {
                showAlert("Failed to cancel flight", "error");
              });
          }
        });
      }

      // Add flight modal
      $("#addFlightBtn").on("click", function () {
        $("#addFlightForm")[0].reset();
        $("#itineraryContainer").html(`
                <div class="itinerary-item-form">
                    <div class="d-flex gap-2 mb-2">
                        <input type="text" class="form-input itinerary-city" placeholder="City" required style="flex: 1;">
                        <input type="datetime-local" class="form-input itinerary-start" placeholder="Start" required>
                        <input type="datetime-local" class="form-input itinerary-end" placeholder="End" required>
                        <button type="button" class="btn btn-danger btn-sm remove-itinerary" style="display: none;">Remove</button>
                    </div>
                </div>
            `);
        $("#addFlightModal").addClass("active");
      });

      // Add itinerary stop
      $("#addItineraryStop").on("click", function () {
        const newStop = $(`
                <div class="itinerary-item-form">
                    <div class="d-flex gap-2 mb-2">
                        <input type="text" class="form-input itinerary-city" placeholder="City" required style="flex: 1;">
                        <input type="datetime-local" class="form-input itinerary-start" placeholder="Start" required>
                        <input type="datetime-local" class="form-input itinerary-end" placeholder="End" required>
                        <button type="button" class="btn btn-danger btn-sm remove-itinerary">Remove</button>
                    </div>
                </div>
            `);
        $("#itineraryContainer").append(newStop);
        updateRemoveButtons();
      });

      // Remove itinerary stop
      $(document).on("click", ".remove-itinerary", function () {
        $(this).closest(".itinerary-item-form").remove();
        updateRemoveButtons();
      });

      function updateRemoveButtons() {
        const stops = $(".itinerary-item-form");
        if (stops.length > 1) {
          $(".remove-itinerary").show();
        } else {
          $(".remove-itinerary").hide();
        }
      }

      // Submit add flight form
      $("#addFlightForm").on("submit", function (e) {
        e.preventDefault();

        const itinerary = [];
        $(".itinerary-item-form").each(function () {
          const city = $(this).find(".itinerary-city").val();
          const start = $(this).find(".itinerary-start").val();
          const end = $(this).find(".itinerary-end").val();

          if (city && start && end) {
            itinerary.push({
              city: city,
              start_datetime: start.replace("T", " ") + ":00",
              end_datetime: end.replace("T", " ") + ":00",
            });
          }
        });

        if (itinerary.length === 0) {
          showAlert("Please add at least one itinerary stop", "error");
          return;
        }

        const flightData = {
          flight_name: $("#flight_name").val(),
          flight_code: $("#flight_code").val().toUpperCase(),
          max_passengers: parseInt($("#max_passengers").val()),
          fees: parseFloat($("#fees").val()),
          itinerary: itinerary,
        };

        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.text();
        submitBtn.prop("disabled", true).text("Adding...");

        addFlight(flightData)
          .done(function (response) {
            if (response.success) {
              showAlert("Flight added successfully!", "success");
              $("#addFlightModal").removeClass("active");
              loadFlights();
            } else {
              showAlert(response.message || "Failed to add flight", "error");
              submitBtn.prop("disabled", false).text(originalText);
            }
          })
          .fail(function (xhr) {
            const response = xhr.responseJSON || {};
            showAlert(response.message || "Failed to add flight", "error");
            submitBtn.prop("disabled", false).text(originalText);
          });
      });

      // Initialize
      $(document).ready(function () {
        requireAuth();
        loadCompanyData();
      });
    </script>
  </body>
</html>
